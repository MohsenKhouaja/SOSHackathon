name: Build and Publish API Docker Image

permissions:
  contents: read # allows checkout
  packages: write # allows pushing to GitHub Container Registry

on:
  push:
    branches: [production]
    paths:
      - 'apps/api/**'
      - 'packages/auth/**'
      - 'packages/db/**'
      - 'packages/logger/**'
      - 'packages/validators/**'
      - 'packages/trpc/**'
      - 'packages/shared/**'
      - 'init/backend/**'
      - 'package.json'
      - 'bun.lock'
      - 'tsconfig.json'
      
  workflow_dispatch: # allows manual trigger

jobs:
  build-and-push-api:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ‚îÄ‚îÄ Build & push backend image ‚îÄ‚îÄ
      - name: Build & push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ghcr.io/lancitn/lanci-api:latest
            ghcr.io/lancitn/lanci-api:${{ github.sha }}

      # ‚îÄ‚îÄ Discord notification on success ‚îÄ‚îÄ
      - name: Discord Success Notification
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚úÖ API Build Successful"
          description: "API Docker image has been successfully built and pushed."
          color: 0x00ff00
          fields: |
            [
              {
                "name": "Repository",
                "value": "${{ github.repository }}",
                "inline": true
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                "inline": true
              },
              {
                "name": "Image Tags",
                "value": "‚Ä¢ `ghcr.io/lancitn/lanci-api:latest`\n‚Ä¢ `ghcr.io/lancitn/lanci-api:${{ github.sha }}`",
                "inline": false
              }
            ]

      # ‚îÄ‚îÄ Discord notification on failure ‚îÄ‚îÄ
      - name: Discord Failure Notification
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚ùå API Build Failed"
          description: "API Docker image build has failed."
          color: 0xff0000
          fields: |
            [
              {
                "name": "Repository",
                "value": "${{ github.repository }}",
                "inline": true
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                "inline": true
              },
              {
                "name": "Workflow Run",
                "value": "[View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                "inline": false
              }
            ]

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push-api
    if: success()

    steps:
      - name: Trigger Dokploy deployment
        run: |
          curl -X POST "${{ secrets.DOKPLOY_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "${{ github.ref_name }}", "commit": "${{ github.sha }}"}'

      - name: Discord Deploy Notification
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "üöÄ API Deployed"
          description: "API has been successfully deployed to Dokploy."
          color: 0x0099ff
          fields: |
            [
              {
                "name": "Repository",
                "value": "${{ github.repository }}",
                "inline": true
              },
              {
                "name": "Branch",
                "value": "${{ github.ref_name }}",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                "inline": true
              }
            ]